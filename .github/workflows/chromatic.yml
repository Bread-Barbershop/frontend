# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„: Chromatic ë°°í¬ ë° ë””ìŠ¤ì½”ë“œ ë¦¬ë·° ì•Œë¦¼
name: 'Chromatic Deployment & Review'

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´ ì„¤ì •
on:
  # 1. PRì´ ë¨¸ì§€ë˜ì–´ main ë¸Œëœì¹˜ì— ì½”ë“œê°€ ë°˜ì˜ë  ë•Œ ì‹¤í–‰ (ë©”ì¸ ìŠ¤í† ë¦¬ë¶ ì£¼ì†Œ ì—…ë°ì´íŠ¸ìš©)
  push:
    branches:
      - main
    paths:
      - 'components/**/*.stories.{ts,tsx,mdx,js,jsx}'
      - 'components/**/*.stories.{ts,tsx,mdx,js,jsx}' 
  # 2. main ë¸Œëœì¹˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ PRì´ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ ì‹¤í–‰ (ë¦¬ë·°ìš©)
  pull_request:
    branches:
      - main
    # íŠ¹ì • í´ë”ì˜ ì»´í¬ë„ŒíŠ¸ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰í•˜ì—¬ ë¶ˆí•„ìš”í•œ ë¹Œë“œ ë°©ì§€
    paths:
      - 'components/**/*.stories.{ts,tsx,mdx,js,jsx}'
      - 'components/**/*.stories.{ts,tsx,mdx,js,jsx}' 

jobs:
  chromatic-deployment:
    runs-on: ubuntu-latest
    steps:
      # ë‹¨ê³„ 1: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Chromaticì€ ì´ì „ ì»¤ë°‹ê³¼ì˜ UI ì°¨ì´ì ì„ ë¹„êµí•˜ë¯€ë¡œ ì „ì²´ ì»¤ë°‹ íˆìŠ¤í† ë¦¬(0)ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.
          fetch-depth: 0

      # ë‹¨ê³„ 2: ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # ë‹¨ê³„ 3: Chromatic ë°°í¬ ë° UI ìŠ¤ëƒ…ìƒ· ìƒì„±
      - name: Publish to Chromatic
        id: chromatic # ë‹¤ìŒ ë‹¨ê³„(ë””ìŠ¤ì½”ë“œ ì•Œë¦¼)ì—ì„œ ê²°ê³¼ URLì„ ì°¸ì¡°í•˜ê¸° ìœ„í•´ ID ì§€ì •
        uses: chromaui/action@v1
        with:
          # GitHub Secretsì— ì €ì¥í•œ í”„ë¡œì íŠ¸ í† í° ì‚¬ìš©
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          token: ${{ secrets.GITHUB_TOKEN }}
          # ë¹Œë“œ ì™„ë£Œ í›„ CIê°€ ë°”ë¡œ ì¢…ë£Œë˜ë„ë¡ ì„¤ì • (ë¦¬ë·°ëŠ” Chromatic ì‚¬ì´íŠ¸ì—ì„œ ì§„í–‰)
          exitOnceUploaded: true
          # [í•µì‹¬ ë¡œì§] main ë¸Œëœì¹˜ì—ì„œ ì‹¤í–‰ë  ë•Œë§Œ ìŠ¤ëƒ…ìƒ·ì„ ìë™ìœ¼ë¡œ ìŠ¹ì¸í•˜ì—¬ ë©”ì¸ URLì„ ìµœì‹ í™”í•¨
          autoAcceptChanges: ${{ github.ref == 'refs/heads/main' }}

      # ë‹¨ê³„ 4: PR ìƒí™©ì—ì„œë§Œ ë””ìŠ¤ì½”ë“œ ì±„ë„ë¡œ ë¦¬ë·° ìš”ì²­ ë©”ì‹œì§€ ì „ì†¡
      - name: Discord Notification
        # push(ë¨¸ì§€) ì´ë²¤íŠ¸ê°€ ì•„ë‹Œ pull_request ì´ë²¤íŠ¸ì¼ ë•Œë§Œ ì´ ë‹¨ê³„ë¥¼ ì‹¤í–‰
        if: github.event_name == 'pull_request'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        uses: Ilshidur/action-discord@master
        with:
          # íŒ€ì›ë“¤ì´ ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì‘ì—…ì, PR ì œëª©, ë¦¬ë·° ì „ìš© ë§í¬ë¥¼ í¬í•¨
          args: |
            ğŸ¨ **ìŠ¤í† ë¦¬ë¶ UI ë¦¬ë·°ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!**
            íŒ€ì›ë¶„ë“¤ (<@1439606262345105569>) ë¦¬ë·°í•´ ì£¼ì„¸ìš”!!
            ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ê³  ìŠ¹ì¸í•´ ì£¼ì„¸ìš”! ğŸ˜

            - **ì‘ì—…ì:** ${{ github.actor }}
            - **PR ì œëª©:** ${{ github.event.pull_request.title }}
            - **ë¦¬ë·° ë° ìŠ¹ì¸ ë§í¬:** ${{ steps.chromatic.outputs.buildUrl }}
            - **ì»´í¬ë„ŒíŠ¸ ë¯¸ë¦¬ë³´ê¸°:** ${{ steps.chromatic.outputs.storybookUrl }}